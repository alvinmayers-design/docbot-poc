name: PR Docs (ALVIN MVP)

on:
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review]
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write

jobs:
  generate:
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout the PR head with full history
      - name: Checkout PR head (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2) Compute diff & detect whether anything changed
      - name: Compute diff & detect changes
        id: diff
        run: |
          set -euo pipefail

          BASE="${{ github.event.pull_request.base.sha }}"
          # Use github.sha, which is the head of the branch checked out by actions/checkout
          HEAD="${{ github.sha }}"
          git fetch --no-tags --prune --depth=1 origin "${BASE}:${BASE}" || true

          git diff --name-only "$BASE" "$HEAD" | tee changed_files.txt
          CHANGED=$(wc -l < changed_files.txt | tr -d ' ')
          if [ "$CHANGED" -gt 0 ]; then
            echo "files_changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "files_changed=false" >> "$GITHUB_OUTPUT"
          fi

          git diff "$BASE" "$HEAD" > full_diff.txt
          # Cap the diff so the prompt stays small (adjust if needed)
          head -c 120000 full_diff.txt > code_diff.txt

      # 3) Build the prompt (only if changes exist) — defensive if the file is missing
      - name: Prepare prompt (ALVIN house style)
  id: prompt
  if: steps.diff.outputs.files_changed == 'true'
  run: |
    set -euo pipefail

    pr_number="${{ github.event.pull_request.number }}"
    pr_title="${{ github.event.pull_request.title }}"
    pr_body="${{ github.event.pull_request.body }}"

    # Fallback for empty body to avoid literal "null"
    if [ -z "${pr_body:-}" ] || [ "${pr_body}" = "null" ]; then
      pr_body="(No description provided in PR)"
    fi

    # Turn changed_files.txt into a Markdown bullet list
    if [ -s changed_files.txt ]; then
      sed 's/^/- /' changed_files.txt > changed_files_bullets.txt
    else
      echo "- (no changed files detected)" > changed_files_bullets.txt
    fi

    cat > prompt_final.txt <<'PROMPT'
You are ALVIN, a concise release-docs writer for pull requests.

Follow this exact Markdown layout:

# ALVIN: PR Documentation

**PR**: #{PR_NUMBER} — {PR_TITLE}

## Summary (1–2 sentences)
- Plain-English TL;DR of what changed and why it matters.

## Changed files
{CHANGED_FILES_AS_BULLETS}

## What changed (by file)
For each changed file, list concrete edits (added/removed/modified) as bullets. Avoid code blocks unless a small snippet clarifies intent.

## Rationale
- Why these changes are needed (context, bug, feature, refactor).
- Any alternatives considered or trade-offs.

## Testing
- Steps the reviewer can run to validate.
- Include commands or “Expected result” when useful.

## Risk & Rollback
- Potential side effects / blast radius.
- How to roll back safely if needed.

## Notes
- Edge cases, follow-ups, or TODOs.

(End of template. Keep it crisp. No chit-chat. No headings not listed above.)
PROMPT

    # Inject dynamic bits
    sed -i "s/#{PR_NUMBER}/$pr_number/g" prompt_final.txt
    # Escape slashes in title so sed is happy
    safe_title=$(printf '%s' "$pr_title" | sed 's/[&/]/\\&/g')
    sed -i "s/{PR_TITLE}/$safe_title/g" prompt_final.txt

    # Insert changed files bullets in place
    awk '
      BEGIN { inserted=0 }
      { 
        if ($0 ~ /\{CHANGED_FILES_AS_BULLETS\}/ && inserted==0) {
          while ((getline line < "changed_files_bullets.txt") > 0) print line
          inserted=1
          next
        }
        print
      }
    ' prompt_final.txt > prompt_final.tmp && mv prompt_final.tmp prompt_final.txt

    # Append a short, safe “diff context” so ALVIN has grounding without bloat
    # (We already trimmed the diff in a previous step.)
    {
      echo
      echo "----"
      echo "Context for ALVIN (do not include as a section in the final output):"
      echo "PR description:"
      echo "$pr_body"
      echo
      echo "Truncated diff follows:"
      sed 's/`/'"''"'/g' code_diff.txt
    } >> prompt_final.txt

      # 4) Call OpenAI (with debug + fallbacks)
      - name: Call OpenAI (with debug + fallbacks)
        id: llm
        if: steps.diff.outputs.files_changed == 'true'
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          set -euo pipefail
          sudo apt-get update >/dev/null && sudo apt-get install -y jq >/dev/null

          MODEL="gpt-4o-mini"    # change here if your account needs another model
          REQ=$(jq -n --arg model "$MODEL" --arg content "$(<prompt_final.txt)" \
            '{model:$model, messages:[{role:"user", content:$content}], temperature:0.2}')

          echo "::group::Prompt preview (first 40 lines)"
          head -n 40 prompt_final.txt || true
          echo "::endgroup::"

          RESP=$(curl -sS -w "\n%{http_code}" https://api.openai.com/v1/chat/completions \
            -H "Authorization: Bearer ${OPENAI_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "$REQ" || true)

          HTTP_CODE="$(echo "$RESP" | tail -n1)"
          BODY_JSON="$(echo "$RESP" | sed '$d')"
          echo "$BODY_JSON" > openai_resp.json
          echo "HTTP_CODE=$HTTP_CODE"

          FILES="$(sed 's/^/- /' changed_files.txt || true)"

          if [ "${HTTP_CODE}" -lt 200 ] || [ "${HTTP_CODE}" -ge 300 ]; then
            ERR_MSG="$(jq -r '.error.message // "Unknown error from OpenAI"' openai_resp.json 2>/dev/null || echo "Unknown error")"
            {
              echo "### ALVIN: LLM call failed"
              echo
              echo "**HTTP**: ${HTTP_CODE}"
              echo
              echo "> ${ERR_MSG}"
              echo
              echo "**Changed files:**"
              echo "${FILES}"
            } > pr_docs.md
            echo "ok=true" >> "$GITHUB_OUTPUT"
          else
            DOC="$(jq -r '.choices[0].message.content // empty' openai_resp.json)"
            {
              echo "### ALVIN: PR Documentation"
              echo
              echo "**Changed files:**"
              echo "${FILES}"
              echo
              if [ -n "$DOC" ]; then
                echo "$DOC"
              else
                echo "_No AI-generated content returned — see debug artifacts._"
              fi
            } > pr_docs.md
            echo "ok=true" >> "$GITHUB_OUTPUT"
          fi

          echo "::group::Doc preview (first 20 lines)"
          head -n 20 pr_docs.md || true
          echo "::endgroup::"

      # 5) Always upload artifacts so debugging is easy
      - name: Upload debug artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: alvin-debug
          path: |
            prompt_final.txt
            changed_files.txt
            openai_resp.json
            pr_docs.md
            full_diff.txt
            code_diff.txt
          if-no-files-found: ignore
          retention-days: 3

      # 6) Comment on the PR if we produced content (even if it's the “LLM failed” fallback)
      - name: Comment on PR (non-empty only)
        if: steps.llm.outputs.ok == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('pr_docs.md','utf8').trim();
            if (!body) {
              core.setFailed("Refusing to post empty comment.");
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body
              });
            }

      # 7) Optional: leave a friendly note if there were no code changes
      - name: Comment on PR (no changes)
        if: steps.diff.outputs.files_changed != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: "No code changes detected in this update — skipping doc generation."
            });
